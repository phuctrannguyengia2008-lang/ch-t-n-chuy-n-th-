<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TG TEAM - CHÍ TÔN VÔ THƯỢNG</title>
    <style>
        * { box-sizing: border-box; }
        body { 
            margin: 0; padding: 0; overflow: hidden; background: #000; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            touch-action: none; user-select: none; -webkit-user-select: none;
            width: 100vw; height: 100vh; 
        }
        canvas { display: block; width: 100%; height: 100%; position: absolute; top: 0; left: 0; }
        
        #ui-layer { position: absolute; inset: 0; pointer-events: none; z-index: 10; }
        
        #stats-box { 
            position: absolute; top: 10px; left: 10px; width: 180px; 
            padding: 10px; background: rgba(0,0,0,0.8); border: 1px solid #ffd700; 
            border-radius: 8px; pointer-events: auto;
        }
        .bar { width: 100%; height: 8px; background: #222; margin: 5px 0; border-radius: 4px; overflow: hidden; border: 1px solid #444; }
        #hp-fill { width: 100%; height: 100%; background: linear-gradient(90deg, #ff1744, #ff5252); transition: width 0.3s; }
        #exp-fill { width: 0%; height: 100%; background: linear-gradient(90deg, #00e5ff, #18ffff); transition: width 0.3s; }
        .skill-txt { font-size: 9px; color: #ffd700; margin-top: 5px; display: flex; justify-content: space-between; font-weight: bold; }

        #boss-ui { 
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%); 
            width: 60%; max-width: 500px; text-align: center; display: none;
        }
        #boss-hp-bar { width: 100%; height: 12px; background: #111; border: 1px solid #ff0000; border-radius: 6px; overflow: hidden; box-shadow: 0 0 10px #ff0000; }
        #boss-hp-fill { width: 100%; height: 100%; background: linear-gradient(90deg, #600, #f00, #600); }

        #mobile-controls { position: absolute; inset: 0; pointer-events: none; display: none; }
        @media (max-width: 1024px) { #mobile-controls { display: block; } }

        #joy-bg { position: absolute; bottom: 50px; left: 50px; width: 120px; height: 120px; background: rgba(255,255,255,0.05); border-radius: 50%; border: 2px solid rgba(0,251,255,0.2); pointer-events: auto; }
        #joy-stick { position: absolute; top: 50%; left: 50%; width: 50px; height: 50px; background: radial-gradient(circle, #00fbff, #008cff); border-radius: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 15px #00fbff; }
        
        .btn-s { position: absolute; width: 75px; height: 75px; background: rgba(0,0,0,0.7); border: 2px solid #ffd700; border-radius: 50%; color: #fff; font-weight: bold; display: flex; align-items: center; justify-content: center; pointer-events: auto; box-shadow: 0 0 10px rgba(255,215,0,0.3); }
        #btn-f { bottom: 60px; right: 140px; border-color: #00e676; color: #00e676; font-size: 14px; }
        #btn-shift { bottom: 150px; right: 50px; border-color: #00e5ff; color: #00e5ff; font-size: 14px; }

        .overlay { position: fixed; inset: 0; background: radial-gradient(circle, #1a1a1a, #000); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; color: #ffd700; text-align: center; }
        .start-btn { padding: 18px 60px; font-size: 22px; background: #ffd700; color: #000; border: none; border-radius: 40px; font-weight: bold; cursor: pointer; margin-top: 25px; box-shadow: 0 0 20px #ffd700; transition: transform 0.2s; }
    </style>
</head>
<body>

<div id="start-screen" class="overlay">
    <h1 style="letter-spacing: 8px; font-size: 40px; margin-bottom: 0;">TG TEAM</h1>
    <p style="color: #ccc; margin-top: 10px;">TU TIÊN CHÍ TÔN VÔ THƯỢNG</p>
    <button class="start-btn" onclick="startGame()">KHỞI ĐẦU TU TIÊN</button>
</div>

<div id="end-screen" class="overlay" style="display: none;">
    <h1 style="color: #ff1744; font-size: 50px;">ĐẠO TIÊU THÂN VONG</h1>
    <p>Tu vi một đời tan thành mây khói...</p>
    <button class="start-btn" onclick="location.reload()">TRỌNG SINH</button>
</div>

<canvas id="gameCanvas"></canvas>

<div id="ui-layer">
    <div id="stats-box">
        <div id="rank-name" style="font-weight: bold; color: #ffd700; font-size: 13px; margin-bottom: 5px;">PHÀM NHÂN - LV.1</div>
        <div class="bar"><div id="hp-fill"></div></div>
        <div class="bar"><div id="exp-fill"></div></div>
        <div class="skill-txt">
            <span>(F) KIẾM TRẬN</span>
            <span>(SHIFT) NÉ</span>
        </div>
    </div>

    <div id="boss-ui">
        <div id="boss-name" style="color: #ff1744; font-weight: bold; font-size: 14px; margin-bottom: 5px; text-shadow: 0 0 5px black;">MA THẦN THƯỢNG CỔ</div>
        <div id="boss-hp-bar"><div id="boss-hp-fill"></div></div>
    </div>

    <div id="mobile-controls">
        <div id="joy-bg"><div id="joy-stick"></div></div>
        <div id="btn-f" class="btn-s">KIẾM</div>
        <div id="btn-shift" class="btn-s">NÉ</div>
    </div>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let gameActive = false, enemies = [], boss = { active: false };
let keys = {};
let joystick = { active: false, x: 0, y: 0, touchId: null };

let p = { 
    x: 100, y: 300, w: 35, h: 45, lv: 1, 
    hp: 1000, maxHp: 1000, exp: 0, dmg: 150,
    fCD: 300, fTimer: 0, fActive: 0, 
    sCD: 200, sTimer: 0, sActive: 0 
};

const RANKS = ["PHÀM NHÂN", "LUYỆN KHÍ", "TRÚC CƠ", "KIM ĐAN", "NGUYÊN ANH", "HÓA THẦN", "CHÍ TÔN"];

function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

window.addEventListener('keydown', e => {
    keys[e.code] = true;
    if(e.code === 'KeyF') triggerSkill('F');
    if(e.code === 'ShiftLeft' || e.code === 'ShiftRight') triggerSkill('SHIFT');
});
window.addEventListener('keyup', e => keys[e.code] = false);

function triggerSkill(type) {
    if(!gameActive) return;
    if(type === 'F' && p.fTimer <= 0) { p.fActive = 120; p.fTimer = p.fCD; }
    if(type === 'SHIFT' && p.sTimer <= 0) { p.sActive = 30; p.sTimer = p.sCD; }
}

const joyBg = document.getElementById('joy-bg');
const joyStick = document.getElementById('joy-stick');

joyBg.addEventListener('touchstart', e => {
    e.preventDefault();
    const touch = e.changedTouches[0];
    joystick.active = true;
    joystick.touchId = touch.identifier;
}, {passive: false});

window.addEventListener('touchmove', e => {
    if(!joystick.active) return;
    for(let i=0; i<e.touches.length; i++) {
        const t = e.touches[i];
        if(t.identifier === joystick.touchId) {
            const rect = joyBg.getBoundingClientRect();
            const centerX = rect.left + rect.width/2;
            const centerY = rect.top + rect.height/2;
            const dx = t.clientX - centerX;
            const dy = t.clientY - centerY;
            const dist = Math.min(Math.hypot(dx, dy), 50);
            const angle = Math.atan2(dy, dx);
            
            joystick.x = (Math.cos(angle) * dist) / 50;
            joystick.y = (Math.sin(angle) * dist) / 50;
            
            // Sửa lỗi: template literal dùng dấu `` và bỏ hàm translate dư thừa
            joyStick.style.transform = `translate(calc(-50% + ${Math.cos(angle)*dist}px), calc(-50% + ${Math.sin(angle)*dist}px))`;
        }
    }
}, {passive: false});

window.addEventListener('touchend', e => {
    for(let i=0; i<e.changedTouches.length; i++) {
        if(e.changedTouches[i].identifier === joystick.touchId) {
            joystick.active = false;
            joystick.touchId = null;
            joystick.x = 0; joystick.y = 0;
            joyStick.style.transform = 'translate(-50%, -50%)';
        }
    }
});

document.getElementById('btn-f').addEventListener('touchstart', e => { e.preventDefault(); triggerSkill('F'); });
document.getElementById('btn-shift').addEventListener('touchstart', e => { e.preventDefault(); triggerSkill('SHIFT'); });

function handleAttack(ex, ey) {
    if(!gameActive) return;
    enemies.forEach(en => {
        if(Math.hypot(ex - en.x, ey - en.y) < 70) en.hp -= p.dmg;
    });
    if(boss.active) {
        boss.parts.forEach(pt => {
            if(Math.hypot(ex - pt.x, ey - pt.y) < 80) boss.hp -= p.dmg;
        });
    }
}

canvas.addEventListener('touchstart', e => {
    e.preventDefault();
    for(let i=0; i<e.changedTouches.length; i++) {
        const t = e.changedTouches[i];
        if(t.identifier !== joystick.touchId) {
            handleAttack(t.clientX, t.clientY);
        }
    }
}, {passive: false});

canvas.addEventListener('mousedown', e => handleAttack(e.clientX, e.clientY));

function startGame() {
    document.getElementById('start-screen').style.display = 'none';
    p.y = canvas.height / 2;
    p.hp = p.maxHp;
    gameActive = true;
}

// Spawner logic
let lastSpawn = 0;
function spawnEnemy() {
    enemies.push({ 
        x: canvas.width + 50, 
        y: 50 + Math.random() * (canvas.height - 150), 
        hp: 200 + p.lv*100, 
        speed: 2.5 + Math.random() * 2 
    });
}

function spawnBoss() {
    boss.active = true;
    boss.maxHp = 10000 * Math.pow(3, Math.floor(p.lv/2));
    boss.hp = boss.maxHp;
    boss.parts = Array(10).fill().map(() => ({x: canvas.width + 100, y: canvas.height/2}));
    document.getElementById('boss-ui').style.display = 'block';
}

function update() {
    if(!gameActive) return;

    // Tự động sinh quái
    let now = Date.now();
    if(!boss.active && now - lastSpawn > 1500) {
        spawnEnemy();
        lastSpawn = now;
    }

    let moveX = joystick.active ? joystick.x : ((keys['KeyD']?1:0)-(keys['KeyA']?1:0));
    let moveY = joystick.active ? joystick.y : ((keys['KeyS']?1:0)-(keys['KeyW']?1:0));
    
    p.x += moveX * 6.5;
    p.y += moveY * 6.5;
    
    p.x = Math.max(0, Math.min(canvas.width - p.w, p.x));
    p.y = Math.max(0, Math.min(canvas.height - 100, p.y));

    if(p.fTimer > 0) p.fTimer--;
    if(p.fActive > 0) p.fActive--;
    if(p.sTimer > 0) p.sTimer--;
    if(p.sActive > 0) p.sActive--;

    enemies.forEach((en, i) => {
        en.x -= en.speed;
        let dist = Math.hypot(p.x + p.w/2 - en.x, p.y + p.h/2 - en.y);
        if(p.fActive > 0 && dist < 120) en.hp -= 15;
        if(dist < 30 && p.sActive <= 0) p.hp -= 4;
        if(en.hp <= 0) { enemies.splice(i, 1); p.exp += 20; }
        else if(en.x < -100) enemies.splice(i, 1);
    });

    if(boss.active) {
        let head = boss.parts[0];
        head.x -= 2;
        head.y = canvas.height/2 + Math.sin(Date.now()*0.002) * 150;
        if(head.x < -200) head.x = canvas.width + 200;

        boss.parts.forEach((pt, i) => {
            if(i > 0) {
                pt.x += (boss.parts[i-1].x - pt.x) * 0.1;
                pt.y += (boss.parts[i-1].y - pt.y) * 0.1;
            }
            let d = Math.hypot(p.x + p.w/2 - pt.x, p.y + p.h/2 - pt.y);
            if(d < 40 && p.sActive <= 0) p.hp -= 10;
            if(p.fActive > 0 && d < 130) boss.hp -= p.dmg / 50;
        });

        document.getElementById('boss-hp-fill').style.width = (boss.hp/boss.maxHp*100) + '%';
        if(boss.hp <= 0) { 
            boss.active = false; 
            p.exp = 100; 
            document.getElementById('boss-ui').style.display = 'none'; 
        }
    }

    if(p.exp >= 100) {
        p.lv++; p.exp = 0; 
        p.maxHp *= 1.5; p.hp = p.maxHp; p.dmg *= 1.4;
        const rankIdx = Math.min(Math.floor((p.lv-1)/2), 6);
        document.getElementById('rank-name').innerText = `${RANKS[rankIdx]} - LV.${p.lv}`;
        if(p.lv % 2 === 0) spawnBoss();
    }

    document.getElementById('hp-fill').style.width = (p.hp/p.maxHp*100) + '%';
    document.getElementById('exp-fill').style.width = p.exp + '%';
    if(p.hp <= 0) { gameActive = false; document.getElementById('end-screen').style.display = 'flex'; }
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    if(!gameActive && p.hp > 0) return;

    ctx.shadowBlur = 15;
    ctx.shadowColor = p.sActive > 0 ? "white" : "#00fbff";
    ctx.fillStyle = p.sActive > 0 ? "rgba(255,255,255,0.5)" : "#00fbff";
    ctx.fillRect(p.x, p.y, p.w, p.h);

    if(p.fActive > 0) {
        ctx.strokeStyle = "#00e676";
        ctx.lineWidth = 4;
        ctx.beginPath();
        ctx.arc(p.x+p.w/2, p.y+p.h/2, 110, 0, Math.PI*2);
        ctx.stroke();
        ctx.setLineDash([20, 10]);
        ctx.lineDashOffset = -Date.now() / 10;
        ctx.stroke();
        ctx.setLineDash([]);
    }

    ctx.shadowColor = "red";
    ctx.fillStyle = "#ff1744";
    enemies.forEach(en => {
        ctx.fillRect(en.x-15, en.y-15, 30, 30);
    });

    if(boss.active) {
        boss.parts.forEach((pt, i) => {
            ctx.shadowColor = i === 0 ? "white" : "red";
            ctx.fillStyle = i === 0 ? "#fff" : "#900";
            ctx.beginPath();
            ctx.arc(pt.x, pt.y, i===0?45:25, 0, Math.PI*2);
            ctx.fill();
        });
    }
    ctx.shadowBlur = 0;
}

function loop() {
    update();
    draw();
    requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>